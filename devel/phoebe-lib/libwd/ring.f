      SUBROUTINE RING(Q,OM,KOMP,L,FR,HLD,R1,RL)
c   Version of September 14, 1998
      IMPLICIT REAL*8(A-H,O-Z)
      DIMENSION RAD(100),THET(100),AA(3),BB(3),FI(150),THA(150),FR(*),
     $HLD(*)
      IX=0
      LR=L+1
      DO 92 I=1,LR
      THA(I)=0.D0
   92 FI(I)=-.1D0
      OMEGA=OM
      K=3
      EL=dfloat(L)
      DEL=2.D0/EL
      CALL ELLONE(1.d0,1.d0,Q,xlsv,OM1,XL2,OM2)
      CALL NEKMIN(Q,OM,xlsv,Z)
      XL=xlsv
      QQ=Q
      XLSQ=XL*XL
      IF(Q.GT.1.D0) QQ=1.D0/Q
      RMAX=DEXP(.345D0*DLOG(QQ)-1.125D0)
      R=RMAX*(OM1-OMEGA)/(OM1-OM2)
      DO 22 IT=1,L
      EYT=dfloat(IT)
      TH=EYT*1.570796326794897d0/EL
      COSQ=DCOS(TH)**2
      DELR=0.D0
   14 R=DABS(R+DELR)
      RSQ=R*R
      X2R2=XLSQ+RSQ
      RX2R2=DSQRT(X2R2)
      XM2R2=(XL-1.D0)**2+RSQ
      RXM2R2=DSQRT(XM2R2)
      OM=1.D0/RX2R2+Q*(1.D0/RXM2R2-XL)+.5D0*(Q+1.D0)*(XLSQ+RSQ*COSQ)
      DOMDR=-R/(X2R2*RX2R2)-Q*R/(XM2R2*RXM2R2)+(Q+1.D0)*COSQ*R
      DELR=(OMEGA-OM)/DOMDR
      ABDELR=DABS(DELR)
      IF(ABDELR.GT..00001D0) GOTO 14
      RAD(IT)=R
   22 THET(IT)=TH*4.D0
      R1=RAD(1)
      RL=RAD(L)
      R90SQ=RL*RL
      DO 18 IJ=1,L
      EYJ=IJ
      RAD(IJ)=RAD(IJ)-(RL-R1)*(EYJ-1.D0)/EL
   18 CONTINUE
      DO 65 N=1,K
      AA(N)=0.D0
   65 BB(N)=0.D0
      DO 29 J=1,L
      DO 29 N=1,K
      EN=N-1
      ENTHET=EN*THET(J)
      AA(N)=AA(N)+RAD(J)*DCOS(ENTHET)*DEL
   29 BB(N)=BB(N)+RAD(J)*DSIN(ENTHET)*DEL
      AA(1)=AA(1)*.5D0
      IF(KOMP.EQ.2) XL=1.d0-xlsv
      XLSQ=XL*XL
      DIS=RL/XL-.0005D0
      DO 42 IR=1,L
      LL=IR-1
      EY=dfloat(L+1-IR)
      THA(IR)=1.570796326794897D0*EY/EL
      IF(THA(IR).LT.1.570796326794897D0) GOTO 82
      COT=0.D0
      GOTO 83
   82 COT=1.D0/DTAN(THA(IR))
   83 IF(COT.GE.DIS) GOTO 50
      COSSQ=DCOS(THA(IR))**2
      A0=AA(1)
      A1=AA(2)
      A2=AA(3)
      B1=BB(2)
      B2=BB(3)
      DELSIN=0.D0
      KNTR=0
      SINTH=DSQRT(COSSQ*(XLSQ+R90SQ)/R90SQ)
   88 SINTH=SINTH+DELSIN
      KNTR=KNTR+1
      IF(SINTH.GT.1.D0) SINTH=1.D0/SINTH
      CSQ=1.D0-SINTH*SINTH
      COSTH=DSQRT(CSQ)
      SINSQ=SINTH*SINTH
      SIN4=8.D0*COSTH**3*SINTH-4.D0*COSTH*SINTH
      COS4=8.D0*CSQ*(CSQ-1.D0)+1.D0
      C4SQ=COS4*COS4
      SINCOS=SIN4*COS4
      RRR=A0+A1*COS4+A2*(C4SQ+C4SQ-1.D0)+B1*SIN4+(B2+B2)*SINCOS
      ARC=dasin(SINTH)
      RR=RRR+(RL-R1)*(2.D0*ARC/3.141592653589793D0-1.D0/EL)
      IF(KNTR.GT.30) GOTO 42
      P=RR*SINTH
      DRDSIN=-A1*SINTH/COSTH-4.D0*A2*SINTH+B1-(B2+B2)*SINSQ/COSTH+(B2+B2
     $)*COSTH+(RL+RL-R1-R1)/(3.141592653589793D0*COSTH)
      DPDSIN=RR+SINTH*DRDSIN
      F=P*P/COSSQ-RR*RR-XLSQ
      DFDSIN=(P+P)*DPDSIN/COSSQ-(RR+RR)*DRDSIN
      DELSIN=-F/DFDSIN
      ABDEL=DABS(DELSIN)
      IF(ABDEL.GT..00001D0)  GOTO 88
   42 FI(IR)=DATAN(RR*COSTH/XL)
   50 LL1=LL+1
      DELTH=1.570796326794897D0/EL
      DO 75 I=1,L
      EY=dfloat(L+1-I)-.5d0
      THE=1.570796326794897D0*EY/EL
      SNTH=DSIN(THE)
      EM=dsin(THE)*EL*1.3d0
      MM=EM+1.d0
      XM=dfloat(MM)
      DELFI=3.141592653589793D0/XM
      HDELFI=1.570796326794897D0/XM
      DO 75 J=1,MM
      IX=IX+1
      IF(I.LE.LL1) GOTO 43
      HLD(IX)=1.d0
      GOTO 75
   43 XJ=MM+1-J
      FE=3.141592653589793D0*(XJ-.5D0)/XM
      PH2=FE+HDELFI
      PHB=PH2
      IF(FI(I).GT.(FE-HDELFI)) GOTO 51
      HLD(IX)=1.d0
      GOTO 75
   51 IPL=I+1
      IF(FI(IPL).GT.0.D0) GOTO 66
      RR=A0+A1-A2+(RL-R1)*(1.D0-1.D0/EL)
      PH1=DELFI*(XJ-1.D0)
      TH1=DATAN(XL/RR)
      GOTO 56
   66 IF(FI(IPL).LT.(FE+HDELFI)) GOTO 52
      HLD(IX)=0.d0
      GOTO 75
   52 IF(FI(IPL).LT.(FE-HDELFI)) GOTO 53
      PH1=FI(IPL)
      TH1=THA(IPL)
      GOTO 56
   53 DELSIN=0.D0
      SINTH=DSQRT(COSSQ*(XLSQ+R90SQ)/R90SQ)
      TANFE=DTAN(FE-HDELFI)
   77 SINTH=SINTH+DELSIN
      IF(SINTH.GT.1.D0) SINTH=1.D0/SINTH
      SINSQ=SINTH*SINTH
      CSQ=1.D0-SINSQ
      COSTH=DSQRT(CSQ)
      SIN4=8.D0*COSTH**3*SINTH-4.D0*COSTH*SINTH
      COS4=8.D0*CSQ*(CSQ-1.D0)+1.D0
      C4SQ=COS4*COS4
      SINCOS=SIN4*COS4
      RRR=A0+A1*COS4+A2*(C4SQ+C4SQ-1.D0)+B1*SIN4+(B2+B2)*SINCOS
      ARC=dasin(SINTH)
      RR=RRR+(RL-R1)*(2.D0*ARC/3.141592653589793D0-1.D0/EL)
      DRDSIN=-A1*SINTH/COSTH-4.D0*A2*SINTH+B1-(B2+B2)*SINSQ/COSTH+(B2+B2
     $)*COSTH+(RL+RL-R1-R1)/(3.141592653589793D0*COSTH)
      F=RR*COSTH-XL*TANFE
      DFDSIN=COSTH*DRDSIN-RR*SINTH/COSTH
      DELSIN=-F/DFDSIN
      ABDEL=DABS(DELSIN)
      IF(ABDEL.GT..00001D0)  GOTO 77
      PH1=FE-HDELFI
      TH1=DATAN(XL/(RR*SINTH*DCOS(PH1)))
   56 IF(FI(I).GT.(FE+HDELFI)) GOTO 57
      PHB=FI(I)
      TH2=THA(I)
      GOTO 60
   57 DELSIN=0.D0
      SINTH=DSQRT(COSSQ*(XLSQ+R90SQ)/R90SQ)
      TANFE=DTAN(FE+HDELFI)
   78 SINTH=SINTH+DELSIN
      IF(SINTH.GT.1.D0) SINTH=1.D0/SINTH
      SINSQ=SINTH*SINTH
      CSQ=1.D0-SINSQ
      COSTH=DSQRT(CSQ)
      SIN4=8.D0*COSTH**3*SINTH-4.D0*COSTH*SINTH
      COS4=8.D0*CSQ*(CSQ-1.D0)+1.D0
      C4SQ=COS4*COS4
      SINCOS=SIN4*COS4
      RRR=A0+A1*COS4+A2*(C4SQ+C4SQ-1.D0)+B1*SIN4+(B2+B2)*SINCOS
      ARC=dasin(SINTH)
      RR=RRR+(RL-R1)*(2.D0*ARC/3.141592653589793D0-1.D0/EL)
      DRDSIN=-A1*SINTH/COSTH-4.D0*A2*SINTH+B1-(B2+B2)*SINSQ/COSTH+(B2+B2
     $)*COSTH+(RL+RL-R1-R1)/(3.141592653589793D0*COSTH)
      F=RR*COSTH-XL*TANFE
      DFDSIN=COSTH*DRDSIN-RR*SINTH/COSTH
      DELSIN=-F/DFDSIN
      ABDEL=DABS(DELSIN)
      IF(ABDEL.GT..00001D0)  GOTO 78
      TH2=DATAN(XL/(RR*SINTH*DCOS(PH2)))
   60 CTHT=DCOS(THA(IPL))
      CTH1=DCOS(TH1)
      CTH2=DCOS(TH2)
      STH1=DSIN(TH1)
      STH2=DSIN(TH2)
      DTH=TH2-TH1
      DCTH=CTH1-CTH2
      OMDP=PH2*DCTH-.5D0*(PH1*STH1+PHB*STH2)*DTH
      OMP=DELFI*(CTHT-CTH1)
      OMN=OMP+OMDP
      HLD(IX)=OMN/(DELTH*DELFI*SNTH)
   75 CONTINUE
      DO 94 JB=1,IX
      JA=IX+1-JB
   94 FR(JB)=HLD(JA)
      RETURN
      END
